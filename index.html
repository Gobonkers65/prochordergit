<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ProChorder Stage - Final</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root {
      --bg-color: #1a1a1a;
      --surface-color: #252525;
      --panel-bg: #2d2d2d;
      --text-main: #e0e0e0;
      --chord-color: #ffffff; 
      --accent: #4e7678; 
      --border: #333;
      --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: var(--font-stack);
      margin: 0; padding: 0;
      height: 100vh;
      height: 100dvh; 
      display: flex; flex-direction: column;
      overflow: hidden;
      overscroll-behavior: none; 
    }

    /* --- TOOLBAR --- */
    .toolbar {
      background-color: var(--surface-color);
      padding: 0 10px; 
      height: 40px; 
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0; z-index: 20;
      position: relative; 
    }
    .title-area { font-weight: bold; font-size: 0.9rem; letter-spacing: 0.5px; }
    .controls { display: flex; gap: 4px; }
    
    button {
      background: #333; color: white; border: 1px solid #444;
      padding: 0 8px; height: 26px; border-radius: 3px;
      font-size: 0.8rem; cursor: pointer; font-weight: 600;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    button:hover { background: #444; }
    button.primary { background-color: var(--accent); border-color: var(--accent); }

    /* --- MAIN LAYOUT --- */
    .main-container {
      display: flex; flex-grow: 1; overflow: hidden;
    }

    /* --- V√ÑNSTER: BIBLIOTEK --- */
    .reference-panel {
      flex-grow: 2;
      background-color: var(--bg-color);
      display: flex; flex-direction: column;
      border-right: 2px solid #000;
      overflow: hidden;
    }
    
    .panel-header-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 10px; background: #262626; border-bottom: 1px solid var(--border);
      flex-shrink: 0; height: 38px;
    }
    .panel-title {
      font-size: 0.75rem; text-transform: uppercase; color: #888; letter-spacing: 1px;
    }

    .add-section-container { position: relative; }
    .btn-add-new {
      background: var(--accent); border: none; width: 24px; height: 24px; font-size: 1.2rem;
      border-radius: 4px; line-height: 1; padding-bottom: 3px;
    }
    
    .add-menu {
      display: none;
      position: absolute; top: 30px; right: 0;
      background: #333; border: 1px solid #555;
      border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      z-index: 100; min-width: 150px;
    }
    .add-menu.visible { display: block; }
    
    .add-menu-item {
      padding: 8px 12px; cursor: pointer; font-size: 0.85rem; color: #eee;
      border-bottom: 1px solid #444;
    }
    .add-menu-item:hover { background: #444; }
    
    #add-menu-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      z-index: 99; display: none; background: transparent;
    }
    #add-menu-overlay.visible { display: block; }


    #unique-sections {
      padding: 8px;
      overflow-y: auto;
      display: flex; flex-wrap: wrap; gap: 8px;
      align-content: flex-start; height: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .ref-card {
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      width: 48%; min-width: 300px;
      flex-grow: 1; display: flex; flex-direction: column;
      position: relative; transition: transform 0.2s, box-shadow 0.2s;
    }
    .ref-card.sortable-ghost { opacity: 0.4; background: #000; }
    .ref-card.highlight {
      box-shadow: 0 0 0 2px #fff; transform: scale(1.01); z-index: 5;
    }

    .ref-header {
      background: rgba(0,0,0,0.3);
      padding: 4px 8px;
      font-size: 0.85rem; font-weight: bold; color: #fff;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      
      /* FIX: F√∂rhindra textmarkering i sektionsrubriker */
      user-select: none;
      -webkit-user-select: none;
    }
    
    .drag-handle {
      cursor: grab; color: rgba(255,255,255,0.4); font-size: 1.1rem;
      margin-right: 8px; line-height: 10px; padding: 0 4px;
      touch-action: none; 
    }
    .drag-handle:hover { color: #fff; }
    .drag-handle:active { cursor: grabbing; }

    .btn-arrow-action {
      background: rgba(255,255,255,0.2); border: none; color: #fff;
      width: 24px; height: 20px; border-radius: 3px; font-size: 0.9rem;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }
    .btn-arrow-action:hover { background: #fff; color: #000; }

    .ref-content {
      padding: 8px; 
      font-family: monospace; white-space: pre-wrap;
      font-size: 1.5rem; font-weight: bold; 
      color: var(--chord-color);
      line-height: 1.15; word-spacing: 0.6em; 
      min-height: 60px; 
      cursor: text;
      outline: none;
    }
    .ref-content:focus {
      background-color: rgba(0,0,0,0.2);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
    }

    /* --- H√ñGER: TIDSLINJE --- */
    .structure-panel {
      width: 100px; 
      min-width: 100px; 
      max-width: 100px;
      background-color: #161616; display: flex; flex-direction: column; flex-shrink: 0;
    }
    .structure-header {
      display: flex; justify-content: center; align-items: center;
      height: 38px; padding: 0 5px;
      background: #222; border-bottom: 1px solid var(--border); 
      color: #888; font-size: 0.75rem; text-transform: uppercase;
      overflow: hidden; white-space: nowrap;
    }

    #timeline-list {
      padding: 5px; overflow-y: auto; display: flex; flex-direction: column; 
      gap: 5px;
      -webkit-overflow-scrolling: touch;
    }

    .timeline-block {
      border: 1px solid rgba(255,255,255,0.1);
      padding: 3px 5px; border-radius: 2px;
      cursor: grab; display: flex; justify-content: space-between; align-items: center;
      user-select: none;
    }
    .timeline-block:hover { filter: brightness(1.2); }
    .timeline-block:active { cursor: grabbing; }

    .t-title { 
      font-weight: bold; font-size: 0.75rem; color: #fff; 
      text-shadow: 0 1px 2px rgba(0,0,0,0.5); 
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      margin-right: 2px;
    }
    .t-remove { color: rgba(255,255,255,0.6); font-size: 0.85rem; cursor: pointer; padding: 0 4px; }
    .t-remove:hover { color: #fff; }

    /* --- EDITOR --- */
    #editor-view {
      display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-color); z-index: 50; flex-direction: column;
    }
    #editor-view.visible { display: flex; }
    
    .editor-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 10px; background: var(--surface-color);
      border-bottom: 1px solid var(--border);
      height: 40px; flex-shrink: 0;
    }

    textarea {
      flex-grow: 1; background: #1a1a1a; color: #fff; border: none; padding: 20px;
      font-family: monospace; font-size: 16px; resize: none; outline: none;
    }

    /* SIDOMENY */
    #side-menu {
      position: absolute; top: 0; left: 0; width: 280px; height: 100%;
      background: #252525; z-index: 60; transform: translateX(-100%);
      transition: transform 0.3s ease; border-right: 1px solid #333; display: flex; flex-direction: column;
    }
    #side-menu.open { transform: translateX(0); }
    #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 55; display: none; }
    #menu-overlay.visible { display: block; }
    .menu-footer { padding: 10px; display: flex; flex-direction: column; gap: 8px; border-top: 1px solid #333; background: #2a2a2a; }
    #song-list { flex-grow: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
    
    .song-item { 
      padding: 12px 10px; border-bottom: 1px solid #333; cursor: pointer; 
      display: flex; justify-content: space-between; font-size: 0.9rem;
      background: #252525; 
      
      /* FIX: F√∂rhindra textmarkering i l√•tlistan */
      user-select: none;
      -webkit-user-select: none;
    }
    .song-item:hover { background: #333; }
    .song-item.sortable-ghost { opacity: 0.4; background: #000; }
    
    .song-drag-handle {
        cursor: grab; padding-right:12px; color:#777; font-size:1.3rem;
        touch-action: none; 
    }

    .menu-btn { width: 100%; height: 32px; margin-bottom: 2px; }

    /* S√ñKF√ÑLT STIL */
    #search-box-container {
      padding: 10px; 
      border-bottom: 1px solid #333; 
      background: #222;
    }
    #song-search {
      width: 100%; 
      padding: 8px; 
      border-radius: 4px; 
      border: 1px solid #444; 
      background: #333; 
      color: #fff;
      font-size: 0.9rem;
      outline: none;
    }
    #song-search:focus { border-color: var(--accent); }

    @media (max-width: 768px) {
      .ref-card { width: 100%; min-width: 100%; } 
    }
  </style>
</head>
<body>

  <div id="add-menu-overlay" onclick="toggleAddMenu(false)"></div>

  <div id="side-menu">
    <div style="padding:15px 10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; background:#222;">
      <span style="font-weight:bold; font-size:1.1rem;">Mina L√•tar</span>
      <button onclick="toggleMenu()" style="background:none; border:none; color:#fff; font-size:1.2rem;">‚úï</button>
    </div>
    
    <div id="search-box-container">
      <input type="text" id="song-search" placeholder="S√∂k l√•t..." oninput="filterSongs()">
    </div>

    <ul id="song-list"></ul>
    
    <div class="menu-footer">
      <button onclick="createNewSong()" class="primary menu-btn">+ Ny L√•t</button>
      
      <div style="height:1px; background:#444; margin:5px 0;"></div>
      
      <button onclick="exportJSON()" class="menu-btn">Spara Backup (Alla l√•tar)</button>
      <input type="file" id="file-import" accept=".json" onchange="importJSON(this)" style="display:none">
      <button onclick="document.getElementById('file-import').click()" class="menu-btn">Importera Backup</button>
      
      <div style="height:1px; background:#444; margin:5px 0;"></div>
      
      <button onclick="exportAllPDFs()" class="menu-btn" style="background:#2c4446; border-color:#385557;">Ladda ner ZIP (PDF:er)</button>
    </div>
  </div>
  <div id="menu-overlay" onclick="toggleMenu()"></div>

  <div class="toolbar">
    <div style="display:flex; align-items:center; gap: 10px;">
      <button onclick="toggleMenu()">‚ò∞</button>
      <div class="title-area" id="display-title">Titel</div>
    </div>
    <div class="controls">
      <button id="btn-trans-down">b</button>
      <button id="btn-trans-up">#</button>
      <button onclick="toggleEditor(true)">‚öôÔ∏è R√•text</button>
    </div>
  </div>

  <div class="main-container">
    
    <div class="reference-panel">
      <div class="panel-header-row">
        <span class="panel-title">Bibliotek (Dra f√∂r att sortera)</span>
        
        <div class="add-section-container">
          <button class="btn-add-new" title="L√§gg till ny sektion" onclick="toggleAddMenu(true)">+</button>
          
          <div class="add-menu" id="section-dropdown">
            <div class="add-menu-item" onclick="addNewSection('Intro')">Intro</div>
            <div class="add-menu-item" onclick="addNewSection('Verse')">Verse</div>
            <div class="add-menu-item" onclick="addNewSection('Chorus')">Chorus</div>
            <div class="add-menu-item" onclick="addNewSection('Stick')">Stick</div>
            <div class="add-menu-item" onclick="addNewSection('Solo')">Solo</div>
            <div class="add-menu-item" onclick="addNewSection('Instru')">Instru</div>
            <div class="add-menu-item" onclick="addNewSection('Outro')">Outro</div>
          </div>
        </div>

      </div>
      <div id="unique-sections">
        </div>
    </div>

    <div class="structure-panel">
      <div class="structure-header">Tidslinje</div>
      <div id="timeline-list">
        </div>
    </div>

  </div>

  <div id="editor-view">
    <div class="editor-header">
       <span style="font-weight:bold; font-size:0.9rem; color:#888;">REDIGERA R√ÖTEXT</span>
       <button onclick="toggleEditor(false)" class="primary">Spara & Visa</button>
    </div>
    <textarea id="raw-input" spellcheck="false" placeholder="Titel&#10;# Intro&#10;Am   G&#10;# Vers 1&#10;Am   C..."></textarea>
  </div>

  <script>
    /* --- CONFIG & DATA --- */
    const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const NOTES_FLAT = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
    
    const SECTION_COLORS = {
      'Verse': '#705a3a',      
      'Chorus': '#57667a',     
      'Stick': '#5d703a', 
      'Bridge': '#3a7065',
      'Solo': '#878786',       
      'Intro': '#4e7678',      
      'Outro': '#8c7374',      
      'Instr': '#3b557a',
      'Instru': '#3b557a',
      'Default': '#696966'
    };

    function normalizeSectionName(name) {
      return name.replace(/\s+\d+$/, '').trim(); 
    }

    function getColor(title) {
      const normal = normalizeSectionName(title);
      for (const key in SECTION_COLORS) {
        if (normal.toLowerCase().includes(key.toLowerCase())) return SECTION_COLORS[key];
      }
      return SECTION_COLORS['Default'];
    }

    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    let songs = [];
    let currentSongId = null; 
    let wakeLock = null; // F√∂r Wake Lock
    
    const rawInput = document.getElementById('raw-input');
    const displayTitle = document.getElementById('display-title');
    const timelineList = document.getElementById('timeline-list');
    const uniqueSectionsContainer = document.getElementById('unique-sections');
    const sideMenu = document.getElementById('side-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const editorView = document.getElementById('editor-view');
    const songListEl = document.getElementById('song-list');
    const songSearchInput = document.getElementById('song-search');

    const sectionDropdown = document.getElementById('section-dropdown');
    const addMenuOverlay = document.getElementById('add-menu-overlay');

    /* --- WAKE LOCK IMPLEMENTERING --- */
    async function activateWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('Sk√§rmen h√•lls vaken');
          
          wakeLock.addEventListener('release', () => {
            console.log('Sk√§rml√•set sl√§pptes');
          });
        } catch (err) {
          console.error(`Kunde inte aktivera Wake Lock: ${err.name}, ${err.message}`);
        }
      }
    }

    // √Öteraktivera om man byter flik och kommer tillbaka
    document.addEventListener('visibilitychange', async () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        await activateWakeLock();
      }
    });

    // Aktivera vid f√∂rsta interaktion (webbl√§sare kr√§ver detta)
    document.addEventListener('click', () => {
        if(!wakeLock) activateWakeLock();
    }, { once: true });
    
    document.addEventListener('touchstart', () => {
        if(!wakeLock) activateWakeLock();
    }, { once: true });


    /* --- SORTERING --- */

    // 1. Tidslinje
    new Sortable(timelineList, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      delay: 150, 
      delayOnTouchOnly: true,
      onEnd: () => rebuildTextFromTimeline()
    });

    // 2. Bibliotek
    new Sortable(uniqueSectionsContainer, {
        animation: 150,
        handle: '.drag-handle', 
        ghostClass: 'sortable-ghost',
        delay: 150,
        delayOnTouchOnly: true
    });

    // 3. L√•tlistan
    new Sortable(songListEl, {
      animation: 150,
      handle: '.song-drag-handle', 
      ghostClass: 'sortable-ghost',
      forceFallback: true, 
      fallbackTolerance: 3, 
      scroll: true, 
      scrollSensitivity: 50,
      scrollSpeed: 20,
      
      onEnd: function (evt) {
        // L√§s av ordningen fr√•n sk√§rmen
        const newOrder = [];
        const domItems = songListEl.querySelectorAll('.song-item');
        
        domItems.forEach(item => {
            const id = item.dataset.id;
            const songObj = songs.find(s => s.id === id);
            if (songObj) newOrder.push(songObj);
        });

        songs = newOrder;
        save();
      }
    });

    /* --- S√ñKFUNKTION (SMART SORTERING) --- */
    function filterSongs() {
      const query = songSearchInput.value.toLowerCase();
      
      if (!query) {
          updateSongList();
          return;
      }

      const items = Array.from(songListEl.querySelectorAll('.song-item'));

      items.sort((a, b) => {
          const titleA = a.querySelector('.song-title-click').innerText.toLowerCase();
          const titleB = b.querySelector('.song-title-click').innerText.toLowerCase();

          // Ta bort siffror/bindestreck i b√∂rjan
          const cleanA = titleA.replace(/^[\d\s-]*\s*/, '');
          const cleanB = titleB.replace(/^[\d\s-]*\s*/, '');

          const startsA = cleanA.startsWith(query);
          const startsB = cleanB.startsWith(query);

          if (startsA && !startsB) return -1;
          if (!startsA && startsB) return 1;
          
          return cleanA.localeCompare(cleanB);
      });

      items.forEach(item => {
        const titleSpan = item.querySelector('.song-title-click');
        if(titleSpan) {
           const title = titleSpan.innerText.toLowerCase();
           
           if(title.includes(query)) {
             item.style.display = ''; 
             songListEl.appendChild(item); 
           } else {
             item.style.display = 'none'; 
           }
        }
      });
    }

    const DEFAULT_SONG = 
`Min L√•t
# Intro
Bm   A   G

# Verse 1
Bm   A   G   F#7`;

    function init() {
      const saved = localStorage.getItem('prochorder_v11');
      if (saved) {
          const loaded = JSON.parse(saved);
          migrateAndLoad(loaded);
      } else {
          migrateAndLoad([{ title: "Exempel-l√•t", content: DEFAULT_SONG, id: generateId() }]);
      }
    }

    function migrateAndLoad(loadedSongs) {
        let needsSave = false;
        
        songs = loadedSongs.map(s => {
            if(!s.id) { s.id = generateId(); needsSave = true; }
            
            // Konvertera ::Verse:: -> # Verse
            if(s.content && s.content.includes('::')) {
               s.content = s.content.replace(/^::(.+?)::/gm, '# $1');
               needsSave = true;
            }
            
            // Fixa titel
            const firstLine = s.content.trim().split('\n')[0];
            if(firstLine && (firstLine.startsWith('#') || firstLine.startsWith('::'))) {
                s.content = s.title + '\n\n' + s.content;
                needsSave = true;
            }
            
            return s;
        });

        if(needsSave) save();
        
        if(songs.length > 0) loadSong(songs[0].id);
        else createNewSong();
    }

    function toggleAddMenu(show) {
      if (show) {
        sectionDropdown.classList.add('visible');
        addMenuOverlay.classList.add('visible');
      } else {
        sectionDropdown.classList.remove('visible');
        addMenuOverlay.classList.remove('visible');
      }
    }

    function parseTextToBlocks(text) {
      const lines = text.split('\n');
      const blocks = [];
      let currentBlock = { title: null, content: [] };

      function trimTrailingEmptyLines(arr) {
        while (arr.length > 0 && arr[arr.length - 1].trim() === '') arr.pop();
        return arr;
      }

      lines.forEach((line, index) => {
        if (index === 0) {
            const trimmed = line.trim();
            if(!trimmed.startsWith('#')) return; 
        }
        
        const trimmed = line.trim();
        if (trimmed.startsWith('#')) {
          if (currentBlock.title) {
            currentBlock.content = trimTrailingEmptyLines(currentBlock.content);
            blocks.push(currentBlock);
          }
          currentBlock = { title: trimmed.substring(1).trim(), content: [] };
        } else {
          if (currentBlock.title) currentBlock.content.push(line);
        }
      });
      if (currentBlock.title) {
        currentBlock.content = trimTrailingEmptyLines(currentBlock.content);
        blocks.push(currentBlock);
      }
      return blocks;
    }

    function renderInterface() {
      const blocks = parseTextToBlocks(rawInput.value);
      
      timelineList.innerHTML = '';
      blocks.forEach(block => {
        timelineList.appendChild(createTimelineBlock(block));
      });

      const currentOrder = [];
      uniqueSectionsContainer.querySelectorAll('.ref-card').forEach(card => {
          currentOrder.push(card.dataset.masterTitle);
      });

      const masterMap = {};
      blocks.forEach(block => {
        const masterName = normalizeSectionName(block.title);
        if (!masterMap[masterName]) {
          masterMap[masterName] = block.content;
        }
      });

      let keys = Object.keys(masterMap);
      if (currentOrder.length > 0) {
          keys.sort((a, b) => {
              const idxA = currentOrder.indexOf(a);
              const idxB = currentOrder.indexOf(b);
              if (idxA !== -1 && idxB !== -1) return idxA - idxB;
              if (idxA !== -1) return -1;
              if (idxB !== -1) return 1;
              return 0;
          });
      }

      uniqueSectionsContainer.innerHTML = '';
      keys.forEach(title => {
        const card = createReferenceCard(title, masterMap[title]);
        uniqueSectionsContainer.appendChild(card);
      });
    }

    function createTimelineBlock(block) {
      const div = document.createElement('div');
      div.className = 'timeline-block';
      div.dataset.title = block.title;
      div.dataset.content = JSON.stringify(block.content);
      div.style.backgroundColor = getColor(block.title);
      
      div.innerHTML = `
        <span class="t-title">${block.title}</span>
        <span class="t-remove" onclick="removeFromTimeline(this)">‚úï</span>
      `;
      div.addEventListener('click', (e) => {
        if(e.target.classList.contains('t-remove')) return;
        highlightReference(normalizeSectionName(block.title));
      });
      return div;
    }

    function createReferenceCard(title, content) {
      const div = document.createElement('div');
      div.className = 'ref-card';
      const idSafe = title.replace(/\s+/g, '-');
      div.id = 'ref-' + idSafe;
      div.dataset.masterTitle = title;
      div.style.backgroundColor = getColor(title);

      div.innerHTML = `
        <div class="ref-header">
          <div style="display:flex; align-items:center;">
             <span class="drag-handle" title="Dra f√∂r att flytta">‚†ø</span>
             <span>${title}</span>
          </div>
          <button class="btn-arrow-action" title="L√§gg till i tidslinjen" onclick="addToTimeline('${title}')">‚ûú</button>
        </div>
        <div class="ref-content" 
             contenteditable="true" 
             spellcheck="false"
             oninput="liveUpdateSection('${title}', this.innerText)"
             >${content.join('\n')}</div>
      `;
      div.dataset.content = JSON.stringify(content);
      return div;
    }

    function liveUpdateSection(sectionTitle, newContent) {
      const newLines = newContent.split('\n');
      const timelineItems = document.querySelectorAll('.timeline-block');
      
      timelineItems.forEach(item => {
         if (normalizeSectionName(item.dataset.title) === sectionTitle) {
             item.dataset.content = JSON.stringify(newLines);
         }
      });

      const refCard = document.getElementById('ref-' + sectionTitle.replace(/\s+/g, '-'));
      if(refCard) {
         refCard.dataset.content = JSON.stringify(newLines);
      }

      let text = rawInput.value;
      const regex = new RegExp(`(# ${sectionTitle}.*?\\n)([\\s\\S]*?)(?=\\n#|$)`, 'g');
      const updatedText = text.replace(regex, `$1${newContent}`);
      
      if (rawInput.value !== updatedText) {
          rawInput.value = updatedText;
          save(); 
      }
    }

    function addNewSection(type) {
      toggleAddMenu(false);

      const blocks = parseTextToBlocks(rawInput.value);
      const exists = blocks.some(b => normalizeSectionName(b.title) === type);
      
      if (!exists) {
         const currentText = rawInput.value;
         const newSectionText = `\n# ${type}\n `; 
         rawInput.value = currentText + newSectionText;
         save();
         renderInterface(); 
      }

      setTimeout(() => {
        const cardId = 'ref-' + type.replace(/\s+/g, '-');
        const card = document.getElementById(cardId);
        
        if(card) {
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          const contentDiv = card.querySelector('.ref-content');
          if(contentDiv) {
            contentDiv.focus();
            const range = document.createRange();
            const sel = window.getSelection();
            range.selectNodeContents(contentDiv);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        }
      }, 150);
    }

    function addToTimeline(title) {
      const refCard = document.getElementById('ref-' + title.replace(/\s+/g, '-'));
      let content = [];
      if (refCard && refCard.dataset.content) {
         content = JSON.parse(refCard.dataset.content);
      }
      const newBlock = { title: title, content: content };
      timelineList.appendChild(createTimelineBlock(newBlock));
      timelineList.scrollTop = timelineList.scrollHeight;
      rebuildTextFromTimeline();
    }

    function removeFromTimeline(el) {
      el.parentElement.remove();
      rebuildTextFromTimeline();
    }

    function highlightReference(title) {
      document.querySelectorAll('.ref-card').forEach(c => c.classList.remove('highlight'));
      const id = 'ref-' + title.replace(/\s+/g, '-');
      const card = document.getElementById(id);
      if (card) {
        card.classList.add('highlight');
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function rebuildTextFromTimeline() {
      const song = songs.find(s => s.id === currentSongId);
      if(!song) return;

      const title = song.title;
      let newText = title + "\n\n";
      const items = timelineList.querySelectorAll('.timeline-block');
      items.forEach(item => {
        const t = item.dataset.title;
        const c = JSON.parse(item.dataset.content);
        newText += "# " + t + "\n" + c.join('\n') + "\n\n";
      });
      rawInput.value = newText;
      save();
    }

    function loadSong(id) {
      const song = songs.find(s => s.id === id);
      if(!song) return;
      
      currentSongId = id;
      rawInput.value = song.content;
      updateTitle(); 
      renderInterface(); 
    }
    
    function updateTitle() {
      const l = rawInput.value.split('\n')[0].trim();
      const song = songs.find(s => s.id === currentSongId);
      if(song) {
          song.title = l || "Namnl√∂s";
          displayTitle.textContent = song.title;
      }
    }
    
    function save() {
      const song = songs.find(s => s.id === currentSongId);
      if(song) {
          song.content = rawInput.value;
      }
      localStorage.setItem('prochorder_v11', JSON.stringify(songs));
    }
    
    function createNewSong() {
      const newId = generateId();
      songs.push({title:"Ny", content:"Ny\n# Intro\n...", id: newId});
      loadSong(newId); toggleMenu(); toggleEditor(true);
    }
    
    function updateSongList() {
      songListEl.innerHTML = '';
      songs.forEach((s) => {
        const li = document.createElement('li');
        li.className='song-item';
        li.dataset.id = s.id; 
        
        li.innerHTML = `
          <div style="display:flex; align-items:center; flex-grow:1; overflow:hidden;">
            <span class="song-drag-handle">‚†ø</span>
            <span class="song-title-click" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${s.title}</span>
          </div>
          <span onclick="delSong('${s.id}', event)" style="padding-left:15px; color:#888;">üóë</span>
        `;
        
        li.querySelector('.song-title-click').onclick = () => { loadSong(s.id); toggleMenu(); };
        
        songListEl.appendChild(li);
      });
      
      if(songSearchInput.value) filterSongs();
    }
    
    function delSong(id, e){ 
        e.stopPropagation(); 
        if(confirm("Ta bort?")){
            const idx = songs.findIndex(s => s.id === id);
            if(idx > -1) songs.splice(idx, 1);
            
            if(!songs.length) createNewSong(); 
            else if(currentSongId === id) loadSong(songs[0].id);
            
            updateSongList(); 
            save();
        }
    }
    
    function toggleMenu(){ 
      sideMenu.classList.toggle('open'); 
      menuOverlay.classList.toggle('visible'); 
      if(sideMenu.classList.contains('open')) {
        songSearchInput.value = ''; 
        updateSongList(); 
      }
    }
    
    function toggleEditor(show){
      if(show) editorView.classList.add('visible');
      else { editorView.classList.remove('visible'); updateTitle(); renderInterface(); save(); }
    }
    
    function transpose(steps) {
      const text = rawInput.value;
      const lines = text.split('\n');
      const newLines = lines.map((line, i) => {
        if(i===0 || line.trim().startsWith('#')) return line;
        return line.replace(/[A-G][b#]?/g, (match) => {
             let index = NOTES.indexOf(match);
             if (index === -1) index = NOTES_FLAT.indexOf(match);
             if (index === -1) return match;
             let newIndex = (index + steps) % 12;
             if (newIndex < 0) newIndex += 12;
             return NOTES[newIndex];
        });
      });
      rawInput.value = newLines.join('\n');
      renderInterface(); save();
    }
    document.getElementById('btn-trans-up').onclick = () => transpose(1);
    document.getElementById('btn-trans-down').onclick = () => transpose(-1);
    
    function exportJSON() {
        save();
        const blob = new Blob([JSON.stringify(songs)], {type:"application/json"});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="prochorder_alla_latar.json"; a.click();
    }
    function importJSON(inp) {
        const f = inp.files[0]; if(!f)return;
        const r = new FileReader(); r.onload=e=>{
            const loaded = JSON.parse(e.target.result);
            migrateAndLoad(loaded);
            toggleMenu();
        }; r.readAsText(f);
    }

    async function exportAllPDFs() {
      save();
      if(!confirm("Detta skapar en ZIP-fil med en PDF f√∂r varje l√•t. Det kan ta n√•gra sekunder.")) return;
      
      const zip = new JSZip();
      
      for (const song of songs) {
        const doc = new jspdf.jsPDF();
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text(song.title, 15, 20);
        
        doc.setFont("courier", "normal");
        doc.setFontSize(12);
        
        let y = 35;
        const lines = song.content.split('\n');
        
        lines.forEach((line, index) => {
          if (index === 0) return; 
          
          if (line.trim().startsWith('#')) {
             doc.setFont("courier", "bold");
             doc.setTextColor(100); 
             if (y > 270) { doc.addPage(); y = 20; }
             doc.text(line.replace('#', '').trim().toUpperCase(), 15, y);
             doc.setTextColor(0); 
             doc.setFont("courier", "normal");
             y += 7;
          } else {
             if (y > 280) { doc.addPage(); y = 20; }
             doc.text(line, 15, y);
             y += 6;
          }
        });
        
        const safeFilename = song.title.replace(/[^a-z0-9√•√§√∂ ]/gi, '_') + ".pdf";
        const pdfBlob = doc.output('blob');
        zip.file(safeFilename, pdfBlob);
      }
      
      const content = await zip.generateAsync({type:"blob"});
      saveAs(content, "Mina_Latar_PDF.zip");
    }

    init();
  </script>
</body>
</html>
